graph TB
    %% Input Sources
    VideoFile[ğŸ“¹ Video File<br/>MP4/AVI/MOV]
    RTSPFeed[ğŸ“¡ RTSP Camera Feed<br/>Live Stream]
    
    %% Frame Reader Service
    FrameReader[ğŸ–¼ï¸ Frame Reader Service<br/>- OpenCV/FFmpeg/GStreamer<br/>- Extract frames from video<br/>- Add timestamps<br/>- Resize/preprocess frames]
    
    %% Message Broker
    MessageBroker[ğŸ“¨ Message Broker<br/>Kafka/RabbitMQ<br/>- Frame buffering<br/>- Stream management<br/>- Topic: video_frames]
    
    %% Detection Service
    DetectionService[ğŸ” Detection Service<br/>- Object detection model<br/>- ROI analysis<br/>- Violation logic<br/>- Hand + Scooper detection]
    
    %% Database
    Database[(ğŸ—„ï¸ Database<br/>- Violation records<br/>- Frame paths<br/>- Bounding boxes<br/>- Timestamps<br/>- Metadata)]
    
    %% Streaming Service
    StreamingService[ğŸŒ Streaming Service<br/>Flask/FastAPI<br/>- REST API endpoints<br/>- WebSocket/WebRTC<br/>- MJPEG streaming]
    
    %% Frontend
    Frontend[ğŸ’» Frontend UI<br/>React/Vue/HTML<br/>- Live video display<br/>- Violation alerts<br/>- ROI visualization<br/>- Statistics dashboard]
    
    %% User Interaction
    User[ğŸ‘¤ User<br/>- Define ROIs<br/>- Monitor violations<br/>- View statistics]
    
    %% Data Flow
    VideoFile --> FrameReader
    RTSPFeed --> FrameReader
    
    FrameReader -->|Publish frames| MessageBroker
    MessageBroker -->|Subscribe to frames| DetectionService
    
    DetectionService -->|Save violations| Database
    DetectionService -->|Send results| StreamingService
    
    StreamingService -->|REST API<br/>/violations/count<br/>/violations/list| Frontend
    StreamingService -->|WebSocket/WebRTC<br/>Live video + detections| Frontend
    
    Database -->|Query violations| StreamingService
    
    Frontend --> User
    User -->|Configure ROIs| Frontend
    Frontend -->|ROI settings| StreamingService
    StreamingService -->|ROI config| DetectionService
    
    %% Violation Detection Logic
    subgraph "ğŸš¨ Violation Detection Logic"
        ViolationLogic["""
        For each frame:
        1. Detect objects (hand, scooper, pizza, ingredients)
        2. Check if hand enters ROI (protein cargo)
        3. Track hand movement and ingredient pickup
        4. Verify scooper usage
        5. If hand â†’ ingredient â†’ pizza WITHOUT scooper:
           âŒ LOG VIOLATION
        6. If hand â†’ scooper â†’ ingredient â†’ pizza:
           âœ… NO VIOLATION
        """]
    end
    
    DetectionService -.-> ViolationLogic
    
    %% Message Topics/Channels
    subgraph "ğŸ“¡ Message Broker Topics"
        Topics["""
        â€¢ video_frames
        â€¢ detection_results
        â€¢ violation_alerts
        â€¢ roi_updates
        """]
    end
    
    MessageBroker -.-> Topics
    
    %% API Endpoints
    subgraph "ğŸ”Œ REST API Endpoints"
        APIs["""
        GET /violations/count
        GET /violations/list
        GET /violations/statistics
        POST /roi/configure
        GET /stream/metadata
        WebSocket: /stream/live
        """]
    end
    
    StreamingService -.-> APIs
    
    %% Styling
    classDef serviceBox fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef dataStore fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef userInterface fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef inputSource fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class FrameReader,DetectionService,StreamingService serviceBox
    class MessageBroker,Database dataStore
    class Frontend,User userInterface
    class VideoFile,RTSPFeed inputSource